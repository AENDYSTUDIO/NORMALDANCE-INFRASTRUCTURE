# План управления секретами для NormalDance

## Обзор

Документ описывает комплексный подход к управлению секретами в проекте NormalDance для предотвращения утечек и обеспечения безопасности.

## Категории секретов

### 1. Критические секреты

- Приватные ключи SSL/TLS сертификатов
- Приватные ключи кошельков блокчейна
- Мастер-ключи баз данных
- API ключи от платежных систем

### 2. Важные секреты

- API ключи внешних сервисов
- Ключи доступа к облачным провайдерам
- Секреты для аутентификации в CI/CD

### 3. Общие секреты

- Пароли от сервисов
- Ключи шифрования
- Временные токены доступа

## Инструменты управления секретами

### 1. Хранилища секретов

- **HashiCorp Vault** - основное хранилище для продакшн
- **AWS Secrets Manager** - для AWS окружений
- **GitHub Secrets** - для CI/CD
- **Docker Secrets** - для контейнеризированных сред

### 2. Инструменты сканирования

- **GitGuardian** - сканирование репозитория
- **TruffleHog** - поиск секретов в коде
- **Gitleaks** - pre-commit хуки
- **Detect-secrets** - интеграция с CI/CD

## Политики и процедуры

### 1. Разработка

#### Запрещено:

- Хранить секреты в исходном коде
- Коммитить `.env` файлы
- Использовать жестко закодированные секреты
- Передавать секреты через мессенджеры

#### Разрешено:

- Использовать переменные окружения
- Хранить секреты в защищенных хранилищах
- Использовать временные токены с ограниченным сроком действия

### 2. Деплоймент

#### Процесс:

1. Все секреты хранятся в Vault
2. При деплое создаются временные переменные окружения
3. После деплоя временные секреты удаляются
4. Аудит всех операций с секретами

### 3. Доступ к секретам

#### Роли и права:

- **Admin** - полный доступ ко всем секретам
- **Dev** - доступ только к dev-секретам
- **CI/CD** - доступ только к необходимым секретам для деплоя
- **Service** - минимальные права для работы сервисов

## Техническая реализация

### 1. Структура переменных окружения

```bash
# .env.example (добавляется в git)
DATABASE_URL=postgresql://user:password@localhost:5432/db
SOLANA_RPC_URL=https://api.devnet.solana.com
JWT_SECRET=your-jwt-secret-here
```

```bash
# .env.local (не добавляется в git)
DATABASE_URL=${VAULT_DATABASE_URL}
SOLANA_RPC_URL=${VAULT_SOLANA_RPC_URL}
JWT_SECRET=${VAULT_JWT_SECRET}
```

### 2. Pre-commit хуки

```bash
#!/bin/sh
# .git/hooks/pre-commit

# Проверка секретов
gitleaks detect --source . --verbose

# Проверка .env файлов
if git diff --cached --name-only | grep -q ".env"; then
    echo "Error: .env files should not be committed"
    exit 1
fi

exit 0
```

### 3. CI/CD интеграция

```yaml
# .github/workflows/security.yml
name: Security Scan

on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TruffleHog
        run: |
          pip install truffleHog
          trufflehog --regex --entropy=False ./
```

### 4. Vault интеграция

```javascript
// src/lib/vault.ts
import Vault from 'hashicorp-vault';

class VaultService {
  private client: Vault;

  constructor() {
    this.client = new Vault({
      url: process.env.VAULT_URL,
      token: process.env.VAULT_TOKEN
    });
  }

  async getSecret(path: string): Promise<string> {
    const result = await this.client.read(path);
    return result.data.value;
  }

  async setSecret(path: string, value: string): Promise<void> {
    await this.client.write(path, { value });
  }
}

export const vaultService = new VaultService();
```

## Мониторинг и аудит

### 1. Логирование

- Все операции с секретами логируются
- Логи хранятся в защищенной системе
- Регулярный анализ логов на подозрительную активность

### 2. Алерты

- Попытки доступа к секретам без прав
- Обнаружение секретов в коде
- Необычная активность с секретами

### 3. Отчеты

- Еженедельный отчет об использовании секретов
- Ежемесячный аудит доступа
- Квартальный обзор безопасности

## Обучение команды

### 1. Обязательное обучение

- Основы безопасности секретов
- Использование инструментов управления секретами
- Процедуры при утечке секретов

### 2. Регулярные тренинги

- Фишинг атаки на секреты
- Практические упражнения по безопасности
- Обновление политик безопасности

## План внедрения

### Фаза 1 (1-2 недели)

1. Настроить Vault для продакшн секретов
2. Внедрить pre-commit хуки
3. Создать .env.example файлы
4. Обучить команду основам

### Фаза 2 (3-4 недели)

1. Перенести все секреты в Vault
2. Настроить CI/CD сканирование
3. Внедрить мониторинг
4. Создать документацию

### Фаза 3 (5-6 недель)

1. Провести полный аудит
2. Настроить ротацию секретов
3. Внедрить автоматизацию
4. Провести тестирование безопасности

## Процедура при утечке

### 1. Немедленные действия

1. Остановить утечку
2. Отозвать скомпрометированные секреты
3. Создать инцидент
4. Уведомить команду

### 2. Расследование

1. Определить масштаб утечки
2. Проанализировать причины
3. Найти все скомпрометированные данные
4. Оценить ущерб

### 3. Восстановление

1. Сгенерировать новые секреты
2. Обновить все системы
3. Провести тестирование
4. Мониторить на повторные инциденты

### 4. Постинцидентный анализ

1. Проанализировать инцидент
2. Обновить процедуры
3. Дополнительное обучение команды
4. Улучшить системы защиты

## Заключение

Эффективное управление секретами - критически важный аспект безопасности проекта. Следование этому плану поможет минимизировать риски утечек и обеспечить надежную защиту данных.

Регулярное обновление политик и процедур необходимо для поддержания высокого уровня безопасности в постоянно меняющейся угрозной среде.
