name: Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'src/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'src/**'
  workflow_dispatch:

jobs:
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate OpenAPI documentation
      run: npm run docs:generate
      env:
        NODE_ENV: documentation
        
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v3
      with:
        name: api-docs
        path: |
          docs/api/
          docs/swagger/
        retention-days: 30

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: generate-api-docs
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install documentation dependencies
      run: |
        npm install -g @vuepress/vuepress@next
        npm install -g vuepress-theme-vue
        
    - name: Download documentation artifacts
      uses: actions/download-artifact@v3
      with:
        name: api-docs
        path: docs/
        
    - name: Build documentation
      run: |
        cd docs
        npm run build
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/.vuepress/dist
        destination_dir: documentation
        cname: docs.normaldance.app
        
    - name: Update documentation index
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/
        git commit -m "Update API documentation" || exit 0
        git push

  update-user-guide:
    name: Update User Guide
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate user guide
      run: npm run docs:user-guide
      env:
        NODE_ENV: documentation
        
    - name: Update user guide in repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/user-guide/
        git commit -m "Update user guide" || exit 0
        git push

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: [deploy-docs, update-user-guide]
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate release notes
      uses: release-drafter/release-drafter@v5
      with:
        config-name: release-drafter.yml
        publish: true
        
    - name: Create release notes file
      run: |
        cat > release-notes.md << EOF
        # Release Notes - ${{ github.event.release.tag_name }}
        
        ## What's New
        
        ### Features
        - New features and improvements
        
        ### Bug Fixes
        - Bug fixes and optimizations
        
        ### Documentation
        - Updated documentation and guides
        
        ## Installation
        
        \`\`\`bash
        npm install normaldance@${{ github.event.release.tag_name }}
        \`\`\`
        
        ## Changelog
        
        For detailed changelog, please see [GitHub Releases](${{ github.event.release.html_url }})
        
        ## Support
        
        If you encounter any issues, please report them on [GitHub Issues](${{ github.repository_url }}/issues)
        EOF
        
    - name: Upload release notes
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release-notes.md
        retention-days: 90

  notify-docs:
    name: Notify Documentation Update
    runs-on: ubuntu-latest
    needs: [deploy-docs, update-user-guide]
    if: always()
    
    steps:
    - name: Send documentation update notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#documentation'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_DOCS }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "attachments": [
              {
                "color": "${{ job.status == 'success' ? 'good' : job.status == 'failure' ? 'danger' : 'warning' }}",
                "title": "Documentation Update - ${{ job.status }}",
                "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "Documentation has been updated for ${{ github.ref_name }} branch",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  }
                ]
              }
            ]
          }