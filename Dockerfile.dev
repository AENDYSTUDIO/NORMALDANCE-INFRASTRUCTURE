# Многоэтапная сборка для NormalDance (упрощенная версия для разработки)

# Этап 1: Установка зависимостей
FROM node:20-alpine AS deps
WORKDIR /app

# Установка зависимостей для сборки native модулей (временно)
RUN apk add --no-cache python3 make g++ py3-pip linux-headers eudev-dev

# Копирование package.json и package-lock.json
COPY package.json package-lock.json ./
COPY mobile-app/package.json mobile-app/package-lock.json ./mobile-app/

# Установка зависимостей для основного приложения
RUN npm ci --only=production --legacy-peer-deps

# Установка зависимостей для мобильного приложения
WORKDIR /app/mobile-app
RUN npm ci --only=production --legacy-peer-deps

WORKDIR /app

# Удаление зависимостей для сборки для уменьшения размера образа
RUN apk del python3 make g++ py3-pip

# Этап 2: Development среда
FROM node:20-alpine AS dev
WORKDIR /app

# Установка зависимостей для работы приложения
RUN apk add --no-cache \
    ffmpeg \
    dumb-init

# Копирование зависимостей
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/mobile-app/node_modules ./mobile-app/node_modules

# Копирование исходного кода
COPY . .

# Экспорт порта
EXPOSE 3000
EXPOSE 301

# Команда для разработки
CMD ["npm", "run", "dev"]