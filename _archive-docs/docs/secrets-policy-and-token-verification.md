# Политика секретов и верификация токенов

## Обзор

Этот документ описывает текущую политику управления секретами и верификации токенов в проекте NormalDance, а также рекомендации по улучшению безопасности.

## Текущая политика секретов

### Управление секретами

1. **Шаблон .env.example**: Используется как шаблон для переменных окружения без реальных значений
2. **Скрипт проверки**: `scripts/check-hardcoded-secrets.js` сканирует код на наличие потенциальных утечек секретов
3. **Исключения**: Определен список файлов и директорий для исключения из проверки

### Типы секретов в проекте

1. **База данных**: `DATABASE_URL`
2. **NextAuth**: `NEXTAUTH_SECRET`, `NEXTAUTH_URL`
3. **Solana**: `NEXT_PUBLIC_SOLANA_RPC_URL`, `SOLANA_RPC_TIMEOUT`
4. **Web3 Program IDs**: `NEXT_PUBLIC_NDT_PROGRAM_ID`, `NEXT_PUBLIC_NDT_MINT_ADDRESS`, и т.д.
5. **IPFS**: `PINATA_API_KEY`, `PINATA_SECRET_KEY`, `PINATA_JWT`
6. **OAuth**: `SPOTIFY_CLIENT_ID`, `SPOTIFY_CLIENT_SECRET`, и т.д.
7. **Redis**: `REDIS_URL`
8. **Sentry**: `SENTRY_DSN`, `NEXT_PUBLIC_SENTRY_DSN`
9. **Telegram**: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEB_APP_URL`, и т.д.
10. **LangGraph**: `LANGGRAPH_API_KEY`, `OPENAI_API_KEY`
11. **JWT**: `JWT_SECRET`
12. **Upstash Redis**: `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`
13. **Analytics**: `MIXPANEL_TOKEN`

## Верификация токенов

### Текущая реализация

1. **NextAuth**: Используется стандартная JWT стратегия
2. **Web3 аутентификация**: Через Solana кошелек с использованием SIWE (Sign-In with Ethereum)
3. **OAuth провайдеры**: Spotify и Apple с соответствующими колбэками

### Потенциальные проблемы

1. **JWT секрет**: Используется общий секрет для всех токенов
2. **Отсутствие ротации**: Нет механизма автоматической ротации секретов
3. **Ограниченная верификация**: Нет расширенной проверки токенов на стороне клиента

## Рекомендации по улучшению

### 1. Управление секретами

1. **Ротация секретов**:

   - Внедрить автоматическую ротацию секретов с помощью CI/CD
   - Создать скрипт `scripts/rotate-secrets.js` для безопасной ротации

2. **Улучшенная проверка**:

   - Расширить паттерны поиска секретов в `scripts/check-hardcoded-secrets.js`
   - Добавить интеграцию с внешними инструментами (trufflehog, git-secrets)

3. **Vault интеграция**:
   - Рассмотреть интеграцию с HashiCorp Vault для управления секретами
   - Использовать провайдеры облачных хранилищ (AWS Secrets Manager, Azure Key Vault)

### 2. Верификация токенов

1. **Улучшенная JWT верификация**:

   - Внедрить отдельные секреты для разных типов токенов
   - Добавить проверку подписи на стороне клиента
   - Реализовать механизм отзыва токенов (blacklist)

2. **Multi-factor аутентификация**:

   - Добавить поддержку 2FA для критических операций
   - Интеграция с TOTP (Time-based One-Time Password)

3. **Rate limiting**:
   - Внедрить ограничение количества запросов на верификацию
   - Использовать Upstash Redis для хранения счетчиков

### 3. Мониторинг и аудит

1. **Логирование**:

   - Добавить подробное логирование всех операций с токенами
   - Интеграция с Sentry для отслеживания подозрительной активности

2. **Алертинг**:
   - Настроить уведомления о подозрительных операциях с токенами
   - Интеграция с Slack/Telegram для оперативных уведомлений

## Практические шаги

### 1. Создание скрипта ротации секретов

```bash
# scripts/rotate-secrets.js
node scripts/rotate-secrets.js --env production
```

### 2. Улучшение проверки секретов

```bash
# Добавить в CI pipeline
npm run security:secrets
```

### 3. Внедрение расширенной верификации токенов

```typescript
// src/lib/token-verification.ts
import { verifyToken } from "./enhanced-jwt";

export async function enhancedTokenVerification(token: string) {
  // Расширенная проверка токена
  const verified = await verifyToken(token);

  // Проверка в черном списке
  const isBlacklisted = await checkTokenBlacklist(token);

  // Проверка IP адреса
  const ipVerified = await verifyRequestIP();

  return verified && !isBlacklisted && ipVerified;
}
```

## Безопасные практики

### 1. Работа с секретами

- Никогда не коммитьте реальные секреты в репозиторий
- Используйте .env.example как шаблон без реальных значений
- Регулярно проверяйте код на наличие утечек секретов

### 2. Хранение секретов

- Используйте менеджеры секретов в продакшене
- Ограничьте доступ к секретам по принципу наименьших привилегий
- Шифруйте секреты при хранении

### 3. Ротация секретов

- Установите регулярный график ротации секретов
- Автоматизируйте процесс ротации через CI/CD
- Тестируйте приложение после ротации секретов

## Интеграция с CI/CD

### Проверки в пайплайне

1. **Статический анализ**: Проверка на наличие секретов
2. **Динамический анализ**: Тестирование аутентификации
3. **Аудит зависимостей**: Проверка уязвимостей в зависимостях

### Автоматизация

```yaml
# .github/workflows/security-checks.yml
- name: Check for hardcoded secrets
  run: npm run security:secrets

- name: Run authentication tests
  run: npm run test:auth

- name: Audit dependencies
  run: npm audit --audit-level high
```

## Заключение

Реализация комплексной политики секретов и верификации токенов критически важна для безопасности проекта. Следование этим рекомендациям поможет защитить чувствительные данные и обеспечить надежную аутентификацию пользователей.
