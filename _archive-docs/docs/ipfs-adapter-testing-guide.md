# Руководство по тестированию IPFS адаптера

## Обзор

Это руководство описывает подход к тестированию IPFS адаптера, включая минимальные тесты, которые были созданы для проверки функциональности Helia-адаптера.

## Структура тестов

### Минимальные тесты

Минимальные тесты находятся в файле `tests/unit/ipfs-adapter-minimal.test.ts` и проверяют:

1. Наличие всех функций адаптера
2. Тип всех функций (должны быть функциями)

### Расширенные тесты

Расширенные тесты находятся в файле `tests/unit/ipfs-helia-adapter.test.ts` и проверяют:

1. Функциональность загрузки файлов
2. Получение файлов из IPFS
3. Получение метаданных
4. Пиннинг и отмену пиннинга файлов
5. Проверку доступности файлов

## Запуск тестов

### Запуск минимальных тестов

```bash
npm run test -- tests/unit/ipfs-adapter-minimal.test.ts
```

### Запуск всех тестов IPFS адаптера

```bash
npm run test -- tests/unit/ipfs-helia-adapter.test.ts
npm run test -- tests/unit/ipfs-adapter-minimal.test.ts
```

### Запуск тестов с покрытием

```bash
npm run test:coverage -- tests/unit/ipfs-helia-adapter.test.ts
npm run test:coverage -- tests/unit/ipfs-adapter-minimal.test.ts
```

## Структура тестовых файлов

### ipfs-adapter-minimal.test.ts

Этот файл содержит минимальные тесты для проверки наличия и типа всех функций адаптера.

### ipfs-helia-adapter.test.ts

Этот файл содержит расширенные тесты, включая моки Helia и проверку функциональности.

## Добавление новых тестов

### Шаги для добавления нового теста

1. Определите функциональность, которую нужно протестировать
2. Создайте новый блок `describe` для этой функциональности
3. Добавьте тесты `it` для различных сценариев
4. При необходимости добавьте моки для внешних зависимостей

### Пример структуры нового теста

```typescript
describe("newFunctionality", () => {
  it("should work correctly", () => {
    // Arrange
    const input = "test input";

    // Act
    const result = someFunction(input);

    // Assert
    expect(result).toBe("expected output");
  });
});
```

## Моки и зависимости

### Моки Helia

В тестах используются моки для Helia и его зависимостей:

```typescript
vi.mock("helia", () => ({
  createHelia: vi.fn(),
}));

vi.mock("@helia/unixfs", () => ({
  unixfs: vi.fn(),
}));
```

### Моки функций

Каждая функция адаптера мокается для проверки различных сценариев:

```typescript
mockHelia = {
  pins: {
    add: vi.fn().mockResolvedValue(undefined),
    rm: vi.fn().mockResolvedValue(undefined),
  },
};
```

## Покрытие тестами

### Цели покрытия

- 100% покрытие для основных функций адаптера
- Тестирование граничных случаев
- Обработка ошибок

### Измерение покрытия

Используйте команду:

```bash
npm run test:coverage
```

## Лучшие практики

### Написание тестов

1. Каждый тест должен быть независимым
2. Используйте понятные названия для тестов
3. Следуйте структуре AAA (Arrange, Act, Assert)
4. Тестируйте как положительные, так и отрицательные сценарии

### Моки

1. Мокайте только внешние зависимости
2. Используйте реалистичные данные для моков
3. Очищайте моки перед каждым тестом

### Асинхронные тесты

1. Используйте async/await для асинхронных функций
2. Тестируйте как успешные, так и неуспешные сценарии
3. Используйте таймауты при необходимости

## Отладка тестов

### Запуск одного теста

```bash
npm run test -- -t "название теста"
```

### Отладка с логами

Добавьте `console.log` для отладки:

```typescript
it("should work correctly", () => {
  console.log("Debug: starting test");
  // ... тестовый код
  console.log("Debug: test completed");
});
```

## Расширение тестов

### Добавление интеграционных тестов

Для тестирования взаимодействия с реальной IPFS сетью создайте интеграционные тесты в отдельной директории.

### Тесты производительности

Добавьте тесты для измерения времени выполнения операций:

```typescript
it("should perform within acceptable time limits", async () => {
  const start = Date.now();
  await someOperation();
  const end = Date.now();

  expect(end - start).toBeLessThan(5000); // 5 seconds
});
```

## Поддержка тестов

### Обновление тестов при изменении API

При изменении API адаптера:

1. Обновите соответствующие тесты
2. Добавьте тесты для новых функций
3. Удалите устаревшие тесты

### Проверка актуальности моков

Регулярно проверяйте, что моки соответствуют реальной реализации Helia.

## Заключение

Тесты IPFS адаптера обеспечивают уверенность в корректной работе функций взаимодействия с IPFS/Helia. Следуя этому руководству, вы сможете поддерживать высокое качество кода и предотвращать регрессии.
