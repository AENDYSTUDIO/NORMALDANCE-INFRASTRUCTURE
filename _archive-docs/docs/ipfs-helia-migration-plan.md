# План миграции IPFS → Helia

## Обзор

Проект уже частично подготовлен к миграции с IPFS HTTP API на Helia. В коде уже есть:

- `src/lib/ipfs.ts` - основной IPFS клиент с поддержкой фичефлага
- `src/lib/ipfs-helia-adapter.ts` - адаптер для Helia
- `src/lib/ipfs-enhanced.ts` - расширенные функции с поддержкой обоих бэкендов

## Текущее состояние

### Фичефлаг

- Используется переменная окружения `IPFS_BACKEND`
- Значение `'helia'` включает Helia бэкенд
- Значение `'legacy'` или отсутствие значения использует старый IPFS HTTP API

### Поддерживаемые функции

1. Загрузка файлов (uploadToIPFS)
2. Загрузка с прогрессом (uploadToIPFSWithProgress)
3. Получение файлов (getFileFromIPFS)
4. Получение метаданных (getMetadataFromIPFS)
5. Пиннинг (pinFile)
6. Отмена пиннинга (unpinFile)
7. Проверка доступности (checkFileAvailability)

## План миграции

### Этап 1: Тестирование и валидация (Текущий этап)

- [x] Создание Helia адаптера
- [x] Реализация всех основных функций для Helia
- [x] Тестирование функций в изоляции
- [x] Сравнение производительности и надежности

### Этап 2: Постепенная миграция

- [ ] Включение Helia для тестовой среды
- [ ] Мониторинг производительности и стабильности
- [ ] Сравнение затрат и производительности
- [ ] Оптимизация конфигурации Helia

### Этап 3: Полный переход

- [ ] Включение Helia как основного бэкенда
- [ ] Удаление устаревшего IPFS HTTP API кода
- [ ] Обновление документации и конфигураций

## Преимущества перехода на Helia

1. **Локальная нода**: Helia работает как локальная нода, что улучшает производительность
2. **Лучшая интеграция**: Прямая интеграция с IPFS без HTTP прокси
3. **Улучшенная безопасность**: Меньше точек отказа и атаки
4. **Производительность**: Быстрее локальное кеширование и доступ к данным
5. **Надежность**: Лучшая устойчивость к сбоям внешних API

## Текущая реализация

### Helia адаптер (src/lib/ipfs-helia-adapter.ts)

- Использует singleton паттерн для Helia инстанса
- Поддерживает все основные операции
- Имеет встроенное управление памятью
- Обеспечивает совместимость с существующим API

### Управление фичефлагом

```typescript
const useHeliaBackend = process.env.IPFS_BACKEND === "helia";
```

## Рекомендации по миграции

### 1. Постепенный переход

- Использовать A/B тестирование между legacy и Helia
- Мониторить метрики производительности
- Сравнивать время загрузки и доступности файлов

### 2. Обработка ошибок

- Реализовать fallback к legacy системе при ошибках
- Логировать все ошибки для анализа
- Обеспечить graceful degradation

### 3. Тестирование

- Провести нагрузочное тестирование
- Проверить работу с большими файлами
- Протестировать восстановление после сбоев

## Конфигурация

### .env переменные

```
IPFS_BACKEND=helia  # или 'legacy' для старой системы
```

### Поддержка обоих бэкендов

Текущая архитектура позволяет:

- Запускать оба бэкенда параллельно
- Легко переключаться между ними
- Сравнивать производительность в реальном времени

## Мониторинг

### Метрики для отслеживания

- Время загрузки/скачивания файлов
- Успешность операций
- Потребление памяти
- Стабильность соединений

## Риски и меры предосторожности

1. **Совместимость**: Убедиться, что все существующие CID остаются валидными
2. **Производительность**: Проверить, что Helia не замедляет операции
3. **Надежность**: Убедиться, что данные остаются доступными
4. **Миграция**: План отката в случае проблем

## Заключение

Проект уже хорошо подготовлен к миграции на Helia. Архитектура с фичефлагом позволяет безопасно тестировать и постепенно переходить на новую систему. Следующим шагом является включение Helia для тестовой среды и мониторинг производительности.
