# Оптимизация vercel.json для NORMALDANCE проекта

## Обзор
Этот документ описывает оптимизации, примененные к файлу vercel.json для максимальной производительности NORMALDANCE проекта.

## 1. Кэширование ответов сервера

### Конфигурация TTL и условий кэширования
- **API-ответы**: `Cache-Control: public, max-age=3600, must-revalidate`
  - TTL: 1 час (3600 секунд)
  - must-revalidate: требует валидации после истечения срока
- **Статические ресурсы**: `Cache-Control: public, max-age=31536000, immutable`
  - TTL: 1 год (31536000 секунд)
  - immutable: ресурсы не меняются, кэш не проверяется
- **Edge caching**: настроен для часто запрашиваемых контентов

### Конфигурация в vercel.json:
```json
"caching": {
  "maxAge": 31536000,
  "staleWhileRevalidate": 86400,
  "unstable_cache": {
    "tags": ["normaldance"],
    "staleWhileRevalidate": 3600
  }
}
```

## 2. Сжатие статических ресурсов

### Включенные алгоритмы:
- **Brotli**: современный алгоритм сжатия с лучшей эффективностью
- **Gzip**: обратная совместимость для старых браузеров

### Поддерживаемые типы файлов:
- **Текстовые**: html, css, js, json, svg
- **Шрифты**: woff, woff2, ttf, eot
- **Изображения**: png, jpg, jpeg, gif, webp

### Конфигурация в vercel.json:
```json
"compression": {
  "brotli": true,
  "gzip": true,
  "text": true,
  "html": true,
  "css": true,
  "js": true,
  "svg": true,
  "json": true,
  "woff": true,
  "woff2": true,
  "ttf": true,
  "eot": true,
  "png": true,
  "jpg": true,
  "jpeg": true,
  "gif": true,
  "webp": true
}
```

## 3. Конфигурация строгих заголовков безопасности

### Content Security Policy (CSP)
- **Глобальный CSP**: разрешает только доверенные источники
- **API CSP**: строгая политика для API эндпоинтов
- **Image CSP**: политика для оптимизированных изображений

### HTTP Strict Transport Security (HSTS)
```json
"Strict-Transport-Security": "max-age=31536000; includeSubDomains; preload"
```

### Другие заголовки безопасности:
- **X-Frame-Options**: DENY - предотвращает кликджекинг
- **X-Content-Type-Options**: nosniff - предотвращает MIME-тип атак
- **X-XSS-Protection**: 1; mode=block - защита от XSS
- **Referrer-Policy**: strict-origin-when-cross-origin - контроль реферера
- **Permissions-Policy**: ограничение доступа к API

## 4. Оптимизация кэширования браузера

### Cache-Control и ETag
- **Статические ассеты**: 1 год кэширования, immutable
- **API ответы**: 1 час кэширования, must-revalidate
- **Изображения**: 1 год кэширования, поддержка webp/avif

### Версионирование статических файлов
- Автоматическое хеширование имен файлов в Next.js
- Поддержка ETag для эффективной валидации кэша

### Оптимизация по типам ресурсов:
- **Шрифты**: кэширование на 1 год, CORS
- **Изображения**: кэширование на 1 год, поддержка современных форматов
- **CSS/JS**: кэширование на 1 год, immutable
- **SVG**: кэширование на 1 год

## 5. Дополнительные оптимизации

### Prerendering
- **Критические страницы**: главная, треки, NFT, профиль, авторизация
- **Fallback**: true - динамическая генерация для остальных страниц

### Edge Caching
- **Регионы**: hkg1, sfo1, iad1, fra1
- **Оптимизация**: глобальное распределение нагрузки

### Image Optimization
- **Размеры**: 640px - 3840px
- **Форматы**: webp, avif, jpg
- **Device Sizes**: адаптивные размеры для разных устройств

### Lazy Loading
- **Изображения**: автоматическая загрузка при прокрутке
- **IFrame**: отложенная загрузка через rewrites

## 6. Производительность функций

### Memory и Duration
- **Memory**: 1024MB для всех API функций
- **Duration**: 30 секунд максимальное время выполнения

### Регионы развертывания
- **Primary**: hkg1, sfo1
- **Edge**: iad1, fra1 (дополнительные для edge caching)

## 7. Мониторинг и логирование

### Crons
- **Рекомендации**: каждые 6 часов
- **Аналитика**: ежедневно в полночь
- **Очистка**: ежедневно в 2 часа ночи

## Рекомендации по использованию

1. **Тестирование**: после развертывания проверить все заголовки
2. **Мониторинг**: отслеживать производительность через Vercel Analytics
3. **Обновления**: регулярно обновлять зависимости для безопасности
4. **Бэкапы**: сохранять предыдущие версии vercel.json

## Откат изменений

Если потребуется откатить изменения:
1. Восстановить предыдущую версию vercel.json
2. Перезапустить деплой
3. Проверить работу приложения

## Контактная информация

Для вопросов по оптимизации обращаться к DevOps команде NORMALDANCE.