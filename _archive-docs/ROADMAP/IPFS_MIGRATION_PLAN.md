# План миграции IPFS на Helia

## Обзор

В этом документе описывается план миграции текущей IPFS-инфраструктуры на современный Helia. Это улучшение имеет высокий приоритет для Q1 2025 года, так как напрямую влияет на надежность и производительность хранения данных в проекте NormalDance.

## Текущая архитектура

### Используемые библиотеки

- `ipfs-http-client` - основная библиотека для взаимодействия с IPFS
- `src/lib/ipfs.ts` - основной модуль IPFS-функционала
- `src/lib/ipfs-enhanced.ts` - расширенные функции с поддержкой нескольких шлюзов

### Проблемы текущей реализации

- Используются устаревшие API IPFS
- Проблемы с производительностью при загрузке больших файлов
- Ограниченная надежность при работе с несколькими шлюзами
- Отсутствие поддержки современных протоколов IPFS

## Цели миграции

### Основные цели

- Повысить надежность и производительность системы хранения
- Обеспечить поддержку современных протоколов IPFS
- Улучшить совместимость с будущими версиями IPFS
- Сократить время загрузки и извлечения файлов

### Технические цели

- Заменить `ipfs-http-client` на `helia`
- Обновить архитектуру модулей `src/lib/ipfs.ts` и `src/lib/ipfs-enhanced.ts`
- Сохранить поддержку нескольких шлюзов
- Обеспечить обратную совместимость с существующим API

## План реализации

### Этап 1: Подготовка (Неделя 1-2)

- Изучение документации Helia
- Анализ текущего IPFS-функционала
- Создание тестовой среды
- Подготовка тестовых данных

### Этап 2: Разработка (Неделя 3-6)

- Создание нового модуля на основе Helia
- Реализация функций загрузки извлечения файлов
- Интеграция с существующей системой
- Написание unit-тестов

### Этап 3: Тестирование (Неделя 7-8)

- Проведение нагрузочного тестирования
- Сравнение производительности с текущей реализацией
- Тестирование надежности и отказоустойчивости
- Тестирование совместимости с различными типами файлов

### Этап 4: Интеграция (Неделя 9-10)

- Постепенная замена текущей реализации
- Обновление документации
- Подготовка руководства по миграции
- Обучение команды

## Технические детали

### Замена основных функций

#### Текущая реализация (ipfs-http-client)

```typescript
import { create } from "ipfs-http-client";

const client = create({
  url: "https://ipfs.infura.io:5001/api/v0",
});

// Загрузка файла
const result = await client.add(file);

// Извлечение файла
const content = await client.cat(result.path);
```

#### Новая реализация (helia)

```typescript
import { createHelia } from "helia";
import { unixfs } from "@helia/unixfs";

const helia = await createHelia({
  // конфигурация
});

const fs = unixfs(helia);

// Загрузка файла
const cid = await fs.add(file);

// Извлечение файла
const content = await fs.cat(cid);
```

### Поддержка нескольких шлюзов

Для обеспечения отказоустойчивости и надежности, необходимо сохранить текущую архитектуру с несколькими шлюзами:

```typescript
const gateways = [
  "https://ipfs.io/ipfs/",
  "https://dweb.link/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/",
  // другие шлюзы
];
```

### Обратная совместимость

Для обеспечения плавного перехода, новая реализация должна поддерживать тот же API, что и текущая:

```typescript
// Интерфейс остается прежним
interface IPFSAdapter {
  upload(file: File | Buffer): Promise<{ cid: string; path: string }>;
  download(cid: string): Promise<Buffer>;
  pin(cid: string): Promise<void>;
  unpin(cid: string): Promise<void>;
  healthCheck(): Promise<boolean>;
}
```

## Риски и меры по их снижению

### Риск 1: Потеря данных при миграции

- **Мера**: Создание резервных копий всех файлов перед миграцией
- **Мера**: Тестирование на изолированной среде

### Риск 2: Проблемы с производительностью

- **Мера**: Проведение нагрузочного тестирования
- **Мера**: Сравнение с текущей реализацией

### Риск 3: Проблемы совместимости

- **Мера**: Покрытие unit-тестами всех функций
- **Мера**: Интеграционное тестирование с основными компонентами

## Критерии успеха

- Производительность новой системы не ниже текущей
- Надежность не ниже текущей (время безотказной работы)
- Совместимость с существующим API
- Успешное прохождение всех тестов
- Обратная совместимость с существующими файлами

## Ресурсы

- 1-2 разработчика на 10 недель
- Тестировщик на 2 недели
- DevOps-инженер для настройки инфраструктуры

## Сроки

- Начало: 1 января 2025
- Завершение: 10 марта 2025
- Общее время: 10 недель
