# DNB1ST Deployment on Render

Этот документ содержит инструкции по развертыванию проекта DNB1ST на Render, включая настройку двух сервисов, мониторинга и логирования.

## Структура проекта

Проект состоит из двух независимых сервисов:

1. **dnb1st.ru** - основной сайт с платформой для музыки
2. **dnb1st.store** - магазин и монетизация

## Файлы конфигурации

### 1. Render Configuration (`.render/config.json`)

Содержит конфигурацию для обоих сервисов Render.

### 2. GitHub Actions (`.github/workflows/deploy-to-render.yml`)

Автоматический деплой при пуше в main ветку.

### 3. Environment Variables (`.env.example`)

Пример переменных окружения для обоих сервисов.

### 4. Health Check Endpoints

- `/api/health` - общий health check
- `/api/health/database` - проверка базы данных
- `/api/health/cache` - проверка Redis
- `/api/health/external` - проверка внешних сервисов

### 5. Monitoring (`src/lib/monitoring.ts`)

Централизованная система мониторинга и логирования.

## Настройка Render

### 1. Создание сервисов

1. Зайдите в ваш аккаунт Render
2. Создайте два новых веб-сервиса:
   - **dnb1st.ru**
   - **dnb1st.store**

### 2. Настройка переменных окружения

Для каждого сервиса настройте следующие переменные окружения:

#### dnb1st.ru

```bash
# Базовые настройки
NODE_ENV=production
BASE_URL=https://dnb1st.ru
NEXT_PUBLIC_BASE_URL=https://dnb1st.ru
SERVICE_NAME=dnb1st-ru

# База данных
DATABASE_URL=postgresql://...

# Redis
REDIS_URL=redis://...

# CDN
CDN_URL=https://cdn.dnb1st.ru

# Аналитика
GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
AMPLITUDE_API_KEY=...

# Социальные сети
SPOTIFY_CLIENT_ID=...
SPOTIFY_CLIENT_SECRET=...
SOUNDCLOUD_CLIENT_ID=...
SOUNDCLOUD_CLIENT_SECRET=...

# Логирование
LOG_LEVEL=info
LOG_FORMAT=json
SENTRY_DSN=...
```

#### dnb1st.store

```bash
# Базовые настройки
NODE_ENV=production
BASE_URL=https://dnb1st.store
NEXT_PUBLIC_BASE_URL=https://dnb1st.store
SERVICE_NAME=dnb1st-store

# База данных
DATABASE_URL=postgresql://...

# Redis
REDIS_URL=redis://...

# CDN
CDN_URL=https://cdn.dnb1st.store

# Платежные системы
STRIPE_SECRET_KEY=...
STRIPE_PUBLISHABLE_KEY=...
STRIPE_WEBHOOK_SECRET=...
YOOKASSA_SHOP_ID=...
YOOKASSA_SECRET_KEY=...

# Аналитика
GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
AMPLITUDE_API_KEY=...

# Логирование
LOG_LEVEL=info
LOG_FORMAT=json
SENTRY_DSN=...
```

### 3. Health Check URLs

Настройте health check URLs для каждого сервиса:

- **dnb1st.ru**: `https://dnb1st.ru/api/health`
- **dnb1st.store**: `https://dnb1st.store/api/health`

### 4. Автоматический деплой

1. Подключите GitHub репозиторий к Render
2. Настройте триггеры деплоя:
   - При пуше в main ветку
   - При создании pull request
   - При тегах

## Мониторинг и логирование

### 1. Sentry

1. Создайте проект в Sentry
2. Получите DSN
3. Добавьте в переменные окружения:
   ```bash
   SENTRY_DSN=https://...
   ```

### 2. New Relic

1. Создайте аккаунт New Relic
2. Получите лицензионный ключ
3. Добавьте в переменные окружения:
   ```bash
   NEW_RELIC_LICENSE_KEY=...
   ```

### 3. Локальное логирование

Логи сохраняются в формате JSON и включают:
- Время события
- Уровень логирования
- Имя сервиса
- Сообщение
- Метаданные
- ID пользователя (если доступно)
- ID запроса (если доступно)

### 4. Метрики

Система собирает следующие метрики:
- Время выполнения запросов
- Количество успешных/неуспешных запросов
- Использование памяти и CPU
- Время отклика базы данных
- Время отклика Redis

## Health Check

### 1. Общий health check

```
GET /api/health
```

Возвращает:
- Статус приложения
- Проверка базы данных
- Проверка Redis
- Проверка внешних сервисов
- Время выполнения

### 2. Проверка базы данных

```
GET /api/health/database
```

Возвращает:
- Статус подключения к базе данных
- Время подключения
- Количество активных соединений
- Время выполнения запросов

### 3. Проверка Redis

```
GET /api/health/cache
```

Возвращает:
- Статус подключения к Redis
- Использование памяти
- Количество подключенных клиентов
- Время выполнения операций

### 4. Проверка внешних сервисов

```
GET /api/health/external
```

Возвращает:
- Статус CDN
- Статус платежных систем
- Статус аналитики
- Статус социальных API

## Оптимизация производительности

### 1. Кэширование

- Redis для сессий и временных данных
- CDN для статических файлов
- Браузерное кэширование

### 2. Мониторинг

- Регулярные health checks
- Алерты при отклонении от нормы
- Автоматическое масштабирование

### 3. Логирование

- Структурированные логи
- Агрегация логов
- Поиск и фильтрация

## Обслуживание

### 1. Бэкапы

- Автоматические бэкапы базы данных
- Бэкапы Redis
- Бэкапы статических файлов

### 2. Обновления

- Автоматические обновления зависимостей
- Канареечные деплои
- Откат при ошибках

### 3. Мониторинг

- Uptime мониторинг
- Производительность
- Ошибки и исключения

## Тестирование

### 1. Health Check тесты

```bash
# Тест общего health check
curl https://dnb1st.ru/api/health

# Тест базы данных
curl https://dnb1st.ru/api/health/database

# Тест Redis
curl https://dnb1st.ru/api/health/cache

# Тест внешних сервисов
curl https://dnb1st.ru/api/health/external
```

### 2. Мониторинг тестов

- Регулярные прогоны health check
- Алерты при сбоях
- Автоматические уведомления

## Troubleshooting

### 1. Проблемы с деплоем

1. Проверьте логи Render
2. Проверьте переменные окружения
3. Проверьте health check URLs
4. Проверьте зависимости

### 2. Проблемы с производительностью

1. Проверьте метрики
2. Проверьте логи ошибок
3. Проверьте использование ресурсов
4. Проверьте внешние сервисы

### 3. Проблемы с мониторингом

1. Проверьте настройки Sentry
2. Проверьте настройки New Relic
3. Проверьте логи
4. Проверьте метрики

## Безопасность

### 1. Переменные окружения

- Все чувствительные данные в переменных окружения
- Регулярное обновление секретов
- Ограниченный доступ

### 2. Health Check

- Только для авторизованных запросов в продакшене
- Логирование всех health check запросов
- Ограничение частоты запросов

### 3. Мониторинг

- Шифрование логов
- Ограниченный доступ к метрикам
- Аудит доступа

## Заключение

Эта настройка обеспечивает надежное развертывание и мониторинг проекта DNB1ST на Render. Все компоненты работают вместе для обеспечения высокой доступности, производительности и безопасности.