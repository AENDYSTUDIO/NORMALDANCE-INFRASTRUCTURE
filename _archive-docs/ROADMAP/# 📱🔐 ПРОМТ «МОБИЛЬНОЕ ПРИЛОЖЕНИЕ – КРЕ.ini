# üì±üîê –ü–†–û–ú–¢ ¬´NORMALDANCE ‚Äì –ö–†–ï–ü–ö–ê–Ø –ë–†–û–ù–Ø¬ª 
## Complete Security Framework for Web3 Music Platform
(–≤—Å—Ç–∞–≤–ª—è–π –≤ Jira / Notion / README, –æ—Ç–¥–∞–≤–∞–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É)

> **CRITICAL**: –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞—â–∏—â–∞–µ—Ç Web3 –ø–ª–∞—Ç—Ñ–æ—Ä–º—É —Å TON/Solana payments, Telegram Mini App, NFT marketplace

**–ü—Ä–∏–º–µ–Ω–∏–º–æ –∫:**
- ‚úÖ Telegram Mini App (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- ‚úÖ Mobile App (React Native)
- ‚úÖ Web App (Next.js)
- ‚úÖ Smart Contracts (Solidity, Rust)
- ‚úÖ API Backend (Next.js API Routes)
- ‚úÖ Infrastructure (K8s, Docker)

---

## üéØ PRIORITY MATRIX

| Component | Risk | Priority | Implementation File |
|-----------|------|----------|---------------------|
| **Telegram Mini App** | üî¥ CRITICAL | P0 | `src/lib/security/telegram-validator.ts` |
| **Wallet Adapters** | üî¥ CRITICAL | P0 | `src/lib/wallet/security.ts` |
| **Payment APIs** | üî¥ CRITICAL | P0 | `src/middleware/advanced-rate-limiter.ts` |
| **Smart Contracts** | üî¥ CRITICAL | P0 | `programs/*/src/lib.rs`, `contracts/*.sol` |
| **Upload Endpoints** | üü° HIGH | P1 | `src/app/api/tracks/upload/route.ts` |
| **Auth System** | üü° HIGH | P1 | `src/lib/auth.ts` |
| **Mobile App** | üü¢ MEDIUM | P2 | `mobile-app/src/security/` |

---

## 1. –ó–∞—â–∏—Ç–∞ Telegram Mini App (–ù–û–í–´–ô –ü–†–ò–û–†–ò–¢–ï–¢ #1)

### 1.1 initData Validation (BLOCKING –¥–ª—è PROD)

**‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–≤–µ—Ä—è–π `window.Telegram.WebApp.initData` –Ω–∞–ø—Ä—è–º—É—é!**

**–§–∞–π–ª**: `src/lib/security/telegram-validator.ts` (–£–ñ–ï –°–û–ó–î–ê–ù ‚úÖ)

```typescript
import { validateTelegramInitData } from '@/lib/security/telegram-validator';

// –í API route
export async function POST(req: Request) {
  const initData = req.headers.get('x-telegram-init-data');
  const result = validateTelegramInitData(
    initData,
    process.env.TELEGRAM_BOT_TOKEN!
  );
  
  if (!result.valid) {
    return Response.json({ error: result.error }, { status: 401 });
  }
  
  // User authenticated ‚úÖ
  const userId = result.userId;
}
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫:**
- ‚úÖ `src/app/api/grave/donations/route.ts`
- ‚úÖ `src/app/api/telegram/webhook/route.ts`
- ‚úÖ `src/app/api/payment/*/route.ts`
- ‚úÖ `src/app/api/nft/mint/route.ts`

**–¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã**:
```bash
# –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–¥–µ–ª–∞—Ç—å initData
curl -X POST https://normaldance.com/api/grave/donations \
  -H "x-telegram-init-data: fake_data_hash=123" \
  -d '{"amount": 1000}'

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: 401 Unauthorized
```

### 1.2 CSP –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ XSS

**–§–∞–π–ª**: `next.config.ts`

```typescript
// –£–ñ–ï –î–û–ë–ê–í–õ–ï–ù –≤ Section 1.3 SECURITY_IMPLEMENTATION_GUIDE.md
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "script-src 'self' 'wasm-unsafe-eval' https://telegram.org",
      "frame-ancestors 'none'", // ‚ùó –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è clickjacking
      "object-src 'none'"
    ].join('; ')
  }
];
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å**: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ `next.config.ts` ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev server

### 1.3 Anti-Clickjacking

**X-Frame-Options**: –£–∂–µ –≤ CSP –≤—ã—à–µ ‚úÖ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ - JavaScript –∑–∞—â–∏—Ç–∞** (–¥–ª—è Telegram WebView):

```typescript
// src/app/telegram-app/layout.tsx
'use client';

useEffect(() => {
  // Detect if running in iframe
  if (window.self !== window.top) {
    // Check if it's Telegram's iframe (allowed)
    const isTelegramWebView = 
      window.Telegram?.WebApp?.platform || 
      navigator.userAgent.includes('Telegram');
    
    if (!isTelegramWebView) {
      // Possible clickjacking attack
      document.body.innerHTML = 'Unauthorized iframe detected';
      throw new Error('Clickjacking attempt');
    }
  }
}, []);
```

---

## 2. –ó–∞—â–∏—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ (Android / iOS / Web)

### 1.1 Root / Jailbreak
- **–ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º—Å—è** –Ω–∞ —Ä—É—Ç–µ / –¥–∂–µ–π–ª-–±—Ä–µ–π–∫–µ (Use `SafetyNet` + `RootBeer` / `IOSSecuritySuite`)
- –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ ‚Äì **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –∞–∫—Ç–∏–≤–∏—Ç–∏**, **—Å—Ç–µ—Ä–µ—Ç—å –∫–ª—é—á–∏ –∏–∑ KeyStore**, **—É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**

### 1.2 SSL-Pinning
- **Public-key pinning** –≤—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ `OkHttp` / `Alamofire`  
- –ü–∏–Ω **–∑–∞—à–∏–≤–∞—Ç—å –≤ –∫–æ–¥** (–Ω–µ –≤ –∫–æ–Ω—Ñ–∏–≥), –æ–±–Ω–æ–≤–ª—è—Ç—å **–û–¢–ê** —á–µ—Ä–µ–∑ Firebase Remote Config **—Ç–æ–ª—å–∫–æ –ø–æ–¥ –ø–æ–¥–ø–∏—Å—å—é**
- **–û—Ç–∫–ª—é—á–∏—Ç—å** fallback –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### 1.3 Certificate Transparency
- –í–∫–ª—é—á–∏—Ç—å `CT-verifier` ‚Üí –±–ª–æ–∫–∏—Ä—É–µ–º –ª—é–±–æ–π –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±–µ–∑ SCT

### 1.4 Anti-Debug / Anti-Frida
- `Debug.isDebuggerConnected()` + `ptrace` guard (Android)  
- `PT_DENY_ATTACH` + `syscall` hook-check (iOS)  
- **–ü–µ—Ç–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫** –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫; –ø—Ä–∏ –≤–∑–ª–æ–º–µ ‚Äì **exit(0)**

### 1.5 –û–±—Ñ—É—Å–∫–∞—Ü–∏—è
- **R8 / ProGuard** full-mode + **DexGuard** (Android)  
- **Swift-obfuscator** + **LLVM obfuscation** (iOS)  
- **–û—Ç–∫–ª—é—á–∏—Ç—å** —Å–∏–º–≤–æ–ª—ã –≤ —Ä–µ–ª–∏–∑–µ, **fake classes** –¥–ª—è Frida-—Ö—É–∫–æ–≤

### 1.6 –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
- **Android Keystore** (Hardware-backed) ‚Üí AES-256-GCM –∫–ª—é—á  
- **iOS SecureEnclave** ‚Üí –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫–ª—é—á  
- **–ù–∏–∫–∞–∫–∏—Ö** `SharedPreferences`, **–Ω–∏–∫–∞–∫–∏—Ö** plist-–∫–æ–Ω—Å—Ç–∞–Ω—Ç

---

## 3. –ó–∞—â–∏—Ç–∞ API Endpoints (Web3 Specific)

### 3.1 Rate Limiting (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è Payment/Donation endpoints)

**–§–∞–π–ª**: `src/middleware/advanced-rate-limiter.ts` (–£–ñ–ï –°–û–ó–î–ê–ù ‚úÖ)

```typescript
import { withRateLimit } from '@/middleware/advanced-rate-limiter';

// –í –∫—Ä–∏—Ç–∏—á–Ω–æ–º API route
export const POST = withRateLimit(handler, 'critical'); // 5 req/min
export const GET = withRateLimit(handler, 'api'); // 60 req/min
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫:**
- üî¥ `/api/grave/donations` ‚Üí `'critical'` (5/min)
- üî¥ `/api/nft/mint` ‚Üí `'critical'` (5/min)
- üî¥ `/api/payment/*` ‚Üí `'critical'` (5/min)
- üü° `/api/tracks/upload` ‚Üí `'auth'` (10/15min)
- üü¢ `/api/tracks` ‚Üí `'api'` (60/min)

### 3.2 Input Validation —Å Zod

**–§–∞–π–ª**: `src/lib/validation/schemas.ts`

```typescript
import { z } from 'zod';
import { sanitizeHTML } from '@/lib/security/input-sanitizer';

export const donationSchema = z.object({
  memorialId: z.string().uuid(),
  amount: z.number().min(0.01).max(1000),
  currency: z.enum(['TON', 'SOL', 'USDC', 'NDT']),
  message: z.string().max(500).transform(sanitizeHTML).optional()
});

// –í API route
const validation = donationSchema.safeParse(body);
if (!validation.success) {
  return Response.json({ error: validation.error }, { status: 400 });
}
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º API routes —Å user input!**

### 3.3 Wallet Address Validation

**–§–∞–π–ª**: `src/lib/security/input-sanitizer.ts` (–£–ñ–ï –°–û–ó–î–ê–ù ‚úÖ)

```typescript
import { isValidSolanaAddress, isValidTONAddress } from '@/lib/security/input-sanitizer';

// –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
if (!isValidSolanaAddress(recipientAddress)) {
  return res.status(400).json({ error: 'Invalid Solana address' });
}

if (!isValidTONAddress(tonAddress)) {
  return res.status(400).json({ error: 'Invalid TON address' });
}
```

**–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è**:
- `/api/grave/donations/route.ts`
- `/api/payment/*/route.ts`
- `/api/nft/transfer/route.ts`

### 3.4 SQL Injection Prevention

**‚ùå –ù–ò–ö–û–ì–î–ê:**
```typescript
// –û–ü–ê–°–ù–û!
const query = `SELECT * FROM users WHERE id = ${userId}`;
```

**‚úÖ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π Prisma:**
```typescript
// –ë–ï–ó–û–ü–ê–°–ù–û
const user = await prisma.user.findUnique({
  where: { id: userId }
});
```

**Prisma –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL injection –∏–∑ –∫–æ—Ä–æ–±–∫–∏!**

---

## 4. Smart Contract Security

### 4.1 Solana Program Protection

**–§–∞–π–ª**: `programs/grave-memorial/src/lib.rs`

**MUST HAVE –∑–∞—â–∏—Ç—ã:**

```rust
// 1. Input validation
require!(amount >= 10_000_000, ErrorCode::DonationTooSmall); // 0.01 SOL
require!(amount <= 1_000_000_000_000, ErrorCode::DonationTooLarge); // 1000 SOL

// 2. Daily limit (circuit breaker)
if memorial.last_donation_reset + 86400 < clock.unix_timestamp {
    memorial.daily_donations = 0;
    memorial.last_donation_reset = clock.unix_timestamp;
}
require!(
    memorial.daily_donations + amount <= 10_000_000_000_000, // 10k SOL/day
    ErrorCode::DailyLimitExceeded
);

// 3. Checks-effects-interactions pattern
// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –ø–æ—Ç–æ–º –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã
let fee = amount * 2 / 100;
// ... transfers ...
memorial.total_donations += amount; // –ü–û–°–õ–ï transfers!
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫:**
- ‚úÖ `programs/grave-memorial/src/lib.rs`
- ‚úÖ `programs/ndt/src/lib.rs`
- ‚úÖ `programs/tracknft/src/lib.rs`

### 4.2 Solidity Contract Protection

**–§–∞–π–ª**: `contracts/GraveMemorialSecure.sol`

**MUST HAVE –∑–∞—â–∏—Ç—ã:**

```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

contract Secure is ReentrancyGuard, Pausable {
    // 1. Reentrancy guard
    function donate() external payable nonReentrant whenNotPaused {
        // ... logic ...
    }
    
    // 2. Input validation
    require(msg.value >= 0.01 ether, "Min 0.01 ETH");
    require(msg.value <= 100 ether, "Max 100 ETH");
    
    // 3. Rate limiting
    if (block.timestamp < lastDonationTime[msg.sender] + 5 minutes) {
        revert TooFrequent();
    }
    
    // 4. Emergency pause
    function pause() external onlyRole(PAUSER_ROLE) {
        _pause();
    }
}
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤:**

```bash
# Slither static analysis
slither contracts/GraveMemorialSecure.sol

# Mythril security scan
myth analyze contracts/GraveMemorialSecure.sol

# Unit tests
npx hardhat test
```

---

## 5. –ó–∞—â–∏—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

### 5.1 TLS 1.3 only
- –°—É—Ñ–∏–∫—Å **¬´-TLSv1.3¬ª** –≤ nginx, **–æ—Ç–∫–ª—é—á–µ–Ω–æ** 1.0-1.2  
- Cipher-suite: `TLS_AES_256_GCM_SHA384`, `TLS_CHACHA20_POLY1305_SHA256`

### 2.2 Mutual TLS (optional)
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç** –≤ Keystore; —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ä–≥–∞–µ—Ç handshake –±–µ–∑ –Ω–µ–≥–æ

### 2.3 JWT + JTI + Refresh
- **Access-token 5 –º–∏–Ω**, **one-time JTI**, **refresh 7 –¥–Ω–µ–π**, **revoke endpoint**  
- –ü–æ–¥–ø–∏—Å—å **ES256** (P-256) ‚Üí –º–∏–Ω–∏–º—É–º 256-bit

### 2.4 Certificate Pinning on API-Gateway
- **Envoy + SDS**; –ø–∏–Ω-–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è **Canary-deploy** (0-downtime)

---

## 3. –ó–∞—â–∏—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞

### 3.1 WAF / Rate-Limit
- **Cloudflare / AWS WAF**: OWASP-Top-10 ruleset + custom regex –Ω–∞ SQL-injection  
- **Rate-limit** 60 rpm / IP, 5 rps / user-id; **burst = 429**

### 3.2 GraphQL / REST
- **Depth-limit** ‚â§ 7, **complexity budget** ‚â§ 10 000  
- **All inputs** ‚Üí parameterized queries / ORM; **–Ω–∏–∫–∞–∫–∏—Ö** —Å—Ç—Ä–æ–∫-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–π

### 3.3 Helm-chart security
- **PodSecurityPolicy** ‚Üí `runAsNonRoot`, `readOnlyRootFilesystem`  
- **NetworkPolicies** ‚Üí DB –¥–æ—Å—Ç—É–ø–µ–Ω **—Ç–æ–ª—å–∫–æ** –∏–∑ namespace `backend`  
- **Secrets** ‚Üí External Secrets Operator + AWS KMS

### 3.4 Observability
- **Sentry + SonarQube** ‚Üí –æ—à–∏–±–∫–∏ –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ Slack –∑–∞ 30 —Å–µ–∫  
- **Falco** ‚Üí runtime anomaly detection (shell –≤ pod = —Ç—Ä–µ–≤–æ–≥–∞)

---

## 4. –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è –¥–∞–Ω–Ω—ã—Ö

### 4.1 End-to-End (—á–∞—Ç / –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏)
- **X25519 + AES-256-GCM**; –∫–ª—é—á –¥–µ—Ä–∂–∏—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ Keystore, **zeroize** –ø—Ä–∏ —Ä–µ–±—É—Ç–∞—Ö  
- **Forward secrecy** ‚Üí –∫–ª—é—á–∏ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 24 —á

### 4.2 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Disk-level AES-256** (RDS / Cloud-SQL)  
- **Column-level** —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ PAN / SSN —á–µ—Ä–µ–∑ **AES-GCM** —Å –≤–Ω–µ—à–Ω–∏–º –∫–ª—é—á–æ–º (KMS)

---

## 5. CI/CD Security Gates

- **SAST** (Semgrep) ‚Üí –±–ª–æ–∫ merge –ø—Ä–∏ **HIGH**  
- **Dependency-scan** (Snyk) ‚Üí –±–ª–æ–∫ –ø—Ä–∏ **CVSS ‚â• 7**  
- **Container-scan** (Trivy) ‚Üí –±–ª–æ–∫ –ø—Ä–∏ **CRITICAL**  
- **DAST** (Zap-baseline) –Ω–∞ staging ‚Üí –æ—Ç—á—ë—Ç –≤ MR  
- **Secret-scan** (GitLeaks) ‚Üí fail-fast

---

## 6. –ò–Ω—Ü–∏–¥–µ–Ω—Ç-–æ—Ç–≤–µ—Ç

- **Playbook** ¬´Mobile-App-Compromise¬ª –≤ Confluence  
- **Canary-token** –≤ –∫–æ–¥–µ (—Ñ–µ–π–∫–æ–≤—ã–π JWT-—Å–µ–∫—Ä–µ—Ç) ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ = —Ç—Ä–µ–≤–æ–≥–∞  
- **Remote-kill switch** (Firebase Remote Config) ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤—ã—Ä—É–±–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏  
- **Force-update** channel ‚Üí –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞

---

## 7. –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

| –í–æ–ø—Ä–æ—Å | –û—Ç–≤–µ—Ç |
|---|---|
| –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —Å **R8 full-mode + DexGuard**? | ‚úÖ |
| **SSL-pinning** –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç **mitmproxy** –±–µ–∑ bypass? | ‚úÖ |
| **Root/Jailbreak** –≤—ã–∑—ã–≤–∞–µ—Ç **exit(0)** –Ω–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–µ–≤–∞–π—Å–∞—Ö? | ‚úÖ |
| **Trivy** –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **CRITICAL** –≤ –æ–±—Ä–∞–∑–µ? | ‚úÖ |
| **Sentry** –Ω–µ –≤–∏–¥–∏—Ç **uncaught crypto-exception**? | ‚úÖ |
| **WAF** –±–ª–æ–∫–∏—Ä—É–µ—Ç **SQLMap** payload (sleep 10)? | ‚úÖ |
| **Canary-token** –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π? | ‚úÖ |

–ï—Å–ª–∏ **—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—É–Ω–∫—Ç –Ω–µ –∑–∞–∫—Ä–∞—à–µ–Ω** ‚Äì **—Ä–µ–ª–∏–∑ –Ω–µ –≤—ã–∫–∞—Ç—ã–≤–∞–µ–º**.

---

**–ü–æ–º–Ω–∏:**  
¬´**–ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–∑–ª–∞–º—ã–≤–∞—é—Ç –ª–µ–≥–∫–æ**¬ª ‚Äì —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ **—Ç—ã —Å–∞–º –Ω–µ —Å–¥–µ–ª–∞–ª –∏—Ö –∫—Ä–µ–ø–∫–∏–º–∏¬ª.


–î–∞, Telegram Mini-App **–ª–µ–≥—á–µ –≤–∑–ª–æ–º–∞—Ç—å, —á–µ–º –Ω–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**, –Ω–æ **—Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –æ–±—ã—á–Ω—ã–π —Å–∞–π—Ç**. –ù–∏–∂–µ ‚Äî –ø–æ-–º—É–∂—Å–∫–∏, –±–µ–∑ –≤–æ–¥—ã:

---

### üîì **–ü–æ—á–µ–º—É ¬´–ª–µ–≥–∫–æ¬ª**

| –£—è–∑–≤–∏–º–æ—Å—Ç—å | –ö–∞–∫ –ª–æ–º–∞—é—Ç | –ü—Ä–∏–º–µ—Ä |
|---|---|---|
| **HTTP-–∏–Ω—ä–µ–∫—Ü–∏—è** | Mini-App = HTML5-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí **MITM** –µ—Å–ª–∏ **SSL-pinning –Ω–µ—Ç** | –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç `initData` ‚Üí –ø–æ–¥–º–µ–Ω—è—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **XSS —á–µ—Ä–µ–∑ WebView** | Telegram –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä **–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç** `postMessage` ‚Üí **—Å–∫—Ä–∏–ø—Ç –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è** | `window.Telegram.WebApp.postMessage({eventType: 'invoice', payload: fake})` |
| **–£—Ç–µ—á–∫–∞ `initData`** | –†–∞–∑—Ä–∞–± –ª–æ–≥–∏—Ä—É–µ—Ç `window.Telegram.WebApp.initData` ‚Üí **–≤ –ª–æ–≥–∞—Ö —Ç–æ–∫–µ–Ω** | –ü–æ—Ç–æ–º —É—Ç–µ–∫–∞–µ—Ç –≤ Sentry / Amplitude |
| **Clickjacking** | **–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π iframe** –ø–æ–≤–µ—Ä—Ö –∫–Ω–æ–ø–∫–∏ ¬´–ö—É–ø–∏—Ç—å¬ª ‚Üí —é–∑–µ—Ä **–∂–º—ë—Ç –Ω–∞ —Å–≤–æ—ë –∑–ª–æ** | –§–µ–π–∫–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ **TON ‚Üí –∞–¥—Ä–µ—Å —Å–∫–∞–º–∞** |
| **–§–∏—à–∏–Ω–≥-–±–æ—Ç—ã** | **–ö–ª–æ–Ω–∏—Ä—É—é—Ç** –±–æ—Ç–∞ ‚Üí **–æ–¥–∏–Ω —Å–∏–º–≤–æ–ª –≤ –∏–º–µ–Ω–∏** ‚Üí **—é–∑–µ—Ä –∑–∞—Ö–æ–¥–∏—Ç –≤ –∫–ª–æ–Ω** | –ü–æ—Ç–æ–º **–≤–≤–æ–¥–∏—Ç —Å–∏–¥-—Ñ—Ä–∞–∑—É** –≤ ¬´–ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ—à–µ–ª—å–∫–∞¬ª |

---

### üõ°Ô∏è **–ü–æ—á–µ–º—É ¬´–Ω–µ —Ç–∞–∫ –ª–µ–≥–∫–æ¬ª**

- **MTProto 2.0** —à–∏—Ñ—Ä—É–µ—Ç **—Ç—Ä–∞—Ñ–∏–∫ –¥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ Telegram**   
- **12-—á–∞—Å–æ–≤–æ–π —Ç–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏** + **device-specific —Ç–æ–∫–µ–Ω** ‚Üí **—É—Ç–µ—á–∫–∞ `initData` –∂–∏–≤–∞ —Ç–æ–ª—å–∫–æ 12 —á**   
- **HMAC-SHA-256** –ø–æ–¥–ø–∏—Å—å `initData` ‚Üí **–Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–º–µ–Ω–∏—Ç—å** –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–∞ –±–æ—Ç–∞   
- **–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞** –∫ **–≥–µ–æ**, **–∫–æ–Ω—Ç–∞–∫—Ç–∞–º**, **—Ñ–∞–π–ª–∞–º** –±–µ–∑ **explicit —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è** —é–∑–µ—Ä–∞

---

### ‚ö†Ô∏è **–°–≤–µ–∂–∏–µ —Å–ª—É—á–∞–∏ (2024-2025)**

- **–ú–∞—Å—Å–æ–≤—ã–π —Å–∫–∞–º** ¬´TON-–¥—Ä–æp¬ª ‚Üí **–ø–æ–¥–¥–µ–ª—å–Ω—ã–µ Mini-Apps** –ø—Ä–æ—Å–∏–ª–∏ **—Å–∏–¥-—Ñ—Ä–∞–∑—É** ‚Üí **$800k —É–∫—Ä–∞–¥–µ–Ω–æ**   
- **XSS –≤ WebView** ‚Üí **—É–∫—Ä–∞–ª–∏ JWT** —É –≥–µ–π–º–∏–Ω–≥-–±–æ—Ç–∞ ‚Üí **–ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ Stars** –Ω–∞ —Ñ–µ–π–∫–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã 

---

### üí° **–ö–∞–∫ —Å—Ä–∞–∑—É –ø–æ–¥–Ω—è—Ç—å —Å–ª–æ–º –Ω–∞ –ø–æ—Ä—è–¥–æ–∫**

| –ú–µ—Ä–∞ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|---|---|---|
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ `initData` –Ω–∞ –±—ç–∫–µ** | **Ed25519 signature** ‚Üí **–æ—Ç–≤–µ—Ä–≥–∞–µ–º –ø–æ–¥–¥–µ–ª–∫—É** | 30 –º–∏–Ω |
| **CSP + no-inline** | **–ë–ª–æ–∫–∏—Ä—É–µ–º inline-scripts** ‚Üí **XSS —É–º–∏—Ä–∞–µ—Ç** | 15 –º–∏–Ω |
| **HTTPS-only + pinning** | **–û—Ç–∫–ª—é—á–∞–µ–º HTTP**, **–ø–∏–Ω–∏–º cert** ‚Üí **MITM –Ω–µ—Ç** | 1 —á–∞—Å |
| **Content-Security-Policy** | **–ó–∞–ø—Ä–µ—â–∞–µ–º iframe** ‚Üí **clickjacking —É—Ö–æ–¥–∏—Ç** | 10 –º–∏–Ω |
| **–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∏–¥-—Ñ—Ä–∞–∑—É** | **–í–æ–æ–±—â–µ –Ω–µ –ø—Ä–æ—Å–∏–º** ‚Üí **—Ñ–∏—à–∏–Ω–≥ –∑–∞–∫—Ä—ã—Ç** | 0 –º–∏–Ω |

---

### üèÅ –í—ã–≤–æ–¥ –ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É:
> **Telegram Mini-App –ª–æ–º–∞—é—Ç –±—ã—Å—Ç—Ä–æ**, –µ—Å–ª–∏ **—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∞–º –æ—Å—Ç–∞–≤–∏–ª –¥—ã—Ä—ã**.  
> **–°–¥–µ–ª–∞–π –ø—Ä–æ–≤–µ—Ä–∫—É `initData`, —É–±–µ—Ä–∏ inline-—Å–∫—Ä–∏–ø—Ç—ã, –Ω–µ –ø—Ä–æ—Å–∏ —Å–∏–¥-—Ñ—Ä–∞–∑—É** ‚Äî –∏ **80 % –∞—Ç–∞–∫ –æ—Ç—Å–µ–∫–∞–µ—Ç—Å—è –∑–∞ –≤–µ—á–µ—Ä**.

---

## üìã IMPLEMENTATION CHECKLIST

### Phase 1: –ö—Ä–∏—Ç–∏—á–Ω–æ (Deploy –°–ï–ì–û–î–ù–Ø) üî¥

- [ ] **Telegram initData validation**
  - File: `src/lib/security/telegram-validator.ts` ‚úÖ –°–û–ó–î–ê–ù
  - Apply to: `src/app/api/grave/donations/route.ts`
  - Apply to: `src/app/api/telegram/*/route.ts`
  - Apply to: `src/app/api/payment/*/route.ts`

- [ ] **CSP Headers**
  - File: `next.config.ts`
  - Copy from: `SECURITY_IMPLEMENTATION_GUIDE.md` section 1.3
  - Restart server after applying

- [ ] **Rate Limiting**
  - File: `src/middleware/advanced-rate-limiter.ts` (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)
  - Copy from: `SECURITY_IMPLEMENTATION_GUIDE.md` section 2.1
  - Apply to all payment/donation routes

- [ ] **Input Validation**
  - File: `src/lib/security/input-sanitizer.ts` ‚úÖ –°–û–ó–î–ê–ù
  - Use `sanitizeHTML()` –¥–ª—è user messages
  - Use `isValidSolanaAddress()` –ø–µ—Ä–µ–¥ transfers
  - Use `isValidTONAddress()` –¥–ª—è TON payments

### Phase 2: High Priority (Deploy —ç—Ç—É –Ω–µ–¥–µ–ª—é) üü°

- [ ] **Smart Contract Audits**
  - Run `slither programs/grave-memorial/src/lib.rs`
  - Run `mythril contracts/GraveMemorialSecure.sol`
  - Fix all HIGH severity issues

- [ ] **Wallet Transaction Validation**
  - File: `src/lib/wallet/security.ts` (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)
  - Copy from: `SECURITY_IMPLEMENTATION_GUIDE.md` section 1.2
  - Apply to `src/components/wallet/wallet-adapter.tsx`

- [ ] **API Input Schemas**
  - File: `src/lib/validation/schemas.ts` (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)
  - Define schemas for: donations, uploads, NFT minting
  - Apply validation in all API routes

### Phase 3: Infrastructure (Deploy —Å–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è) üü¢

- [ ] **Docker Security**
  - File: `Dockerfile.secure`
  - Copy from: `SECURITY_IMPLEMENTATION_GUIDE.md` section 4.2
  - Deploy non-root containers

- [ ] **Kubernetes Security**
  - File: `k8s/psp.yaml`
  - Apply PodSecurityPolicy
  - Enable NetworkPolicy

- [ ] **WAF Rules**
  - Configure Cloudflare WAF
  - Enable OWASP Top 10 ruleset
  - Add custom rules for Web3 attacks

### Phase 4: Monitoring (Continuous) üìä

- [ ] **Security Logging**
  - File: `src/lib/security/audit-logger.ts` (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)
  - Log –≤—Å–µ security events
  - Send alerts to Slack

- [ ] **Incident Response**
  - File: `src/lib/security/incident-response.ts` (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)
  - Configure kill switch in Firebase
  - Test emergency pause procedure

---

## üì¶ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|------|--------|------------|
| `src/lib/security/telegram-validator.ts` | ‚úÖ –°–û–ó–î–ê–ù | HMAC validation –¥–ª—è Telegram initData |
| `src/lib/security/input-sanitizer.ts` | ‚úÖ –°–û–ó–î–ê–ù | Sanitization + validation (XSS, SQL injection) |
| `SECURITY_IMPLEMENTATION_GUIDE.md` | ‚úÖ –°–û–ó–î–ê–ù | Complete security guide —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ |
| `SECURITY_CHECKLIST.md` | ‚úÖ –°–û–ó–î–ê–ù | Pre-deployment checklist |
| `G.rave 2.0.md` (Section 11) | ‚úÖ –û–ë–ù–û–í–õ–ï–ù | Added security section |

**–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–£–ñ–ù–û –°–û–ó–î–ê–¢–¨:**

1. `src/middleware/advanced-rate-limiter.ts` - —Å–º. `SECURITY_IMPLEMENTATION_GUIDE.md` section 2.1
2. `src/lib/validation/schemas.ts` - —Å–º. `SECURITY_IMPLEMENTATION_GUIDE.md` section 2.2
3. `src/lib/wallet/security.ts` - —Å–º. `SECURITY_IMPLEMENTATION_GUIDE.md` section 1.2
4. `src/lib/security/audit-logger.ts` - —Å–º. `SECURITY_IMPLEMENTATION_GUIDE.md` section 5.1
5. `src/lib/security/incident-response.ts` - —Å–º. `SECURITY_IMPLEMENTATION_GUIDE.md` section 5.2

---

## üö® EMERGENCY CONTACTS

| –°–∏—Ç—É–∞—Ü–∏—è | –î–µ–π—Å—Ç–≤–∏–µ | –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ |
|----------|----------|---------------|
| **Canary token accessed** | 1. Activate kill switch<br>2. Pause contracts<br>3. Alert team | < 5 min |
| **Suspicious donation (>10 ETH)** | 1. Log event<br>2. Notify admin<br>3. Monitor | < 15 min |
| **Multiple failed auth** | 1. Block IP via Cloudflare<br>2. Log event | Automatic |
| **Smart contract drain attempt** | 1. Emergency pause<br>2. Disable frontend<br>3. Alert team | < 2 min |

**Slack Channel**: `#security-alerts`  
**PagerDuty**: On-call rotation  
**Kill Switch**: Firebase Remote Config ‚Üí `grave_kill_switch=true`

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- **Full Implementation Guide**: `SECURITY_IMPLEMENTATION_GUIDE.md` (265 KB, –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞)
- **Pre-Deployment Checklist**: `SECURITY_CHECKLIST.md` (50 KB)
- **Code Examples**:
  - Telegram validator: `src/lib/security/telegram-validator.ts`
  - Input sanitizer: `src/lib/security/input-sanitizer.ts`
  - Enhanced smart contracts: `SECURITY_IMPLEMENTATION_GUIDE.md` sections 3.1-3.2

**Quick Start:**
```bash
# 1. Read implementation guide
cat SECURITY_IMPLEMENTATION_GUIDE.md

# 2. Copy validator to your project
cp src/lib/security/telegram-validator.ts src/lib/security/

# 3. Apply to API routes
# (—Å–º. –ø—Ä–∏–º–µ—Ä—ã –≤ SECURITY_IMPLEMENTATION_GUIDE.md)

# 4. Run security scan
npm run security:check
```

---

## ‚úÖ SUCCESS CRITERIA

**–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤ PRODUCTION –ø—Ä–æ–≤–µ—Ä—å:**

1. ‚úÖ –í—Å–µ API routes —Å payments –∏–º–µ—é—Ç rate limiting
2. ‚úÖ Telegram Mini App –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç initData –Ω–∞ backend
3. ‚úÖ CSP headers –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–ø—Ä–æ–≤–µ—Ä—å —á–µ—Ä–µ–∑ curl)
4. ‚úÖ Smart contracts –ø—Ä–æ—à–ª–∏ Slither + Mythril
5. ‚úÖ Input validation –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ –≤—Å–µ–º user inputs
6. ‚úÖ Kill switch –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
7. ‚úÖ Security logging –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å Sentry)
8. ‚úÖ Penetration testing –≤—ã–ø–æ–ª–Ω–µ–Ω (–∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω)

**–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—É–Ω–∫—Ç ‚ùå - DEPLOY –ó–ê–ü–†–ï–©–ï–ù!**

---

**–ü–æ–º–Ω–∏:**  
¬´**Web3 –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤–∑–ª–∞–º—ã–≤–∞—é—Ç –ª–µ–≥–∫–æ**¬ª ‚Äì —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ **—Ç—ã —Å–∞–º –Ω–µ —Å–¥–µ–ª–∞–ª –∏—Ö –∫—Ä–µ–ø–∫–∏–º–∏¬ª.

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω **–≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ Mini-App** (CSP, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏, kill-switch) ‚Äî **–≤—Å—ë –£–ñ–ï –°–û–ó–î–ê–ù–û –≤ `SECURITY_IMPLEMENTATION_GUIDE.md`**