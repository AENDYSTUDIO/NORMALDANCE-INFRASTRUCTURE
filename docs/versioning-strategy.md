# Стратегия управления версиями NormalDANCE (Семантическое версионирование 2.0.0)

## Описание

Эта документация описывает стратегию управления версиями для NormalDANCE, основанную на спецификации Семантического Версионирования (SemVer) 2.0.0 и интегрированную с процессом CI/CD. См. также полную спецификацию в [SEMVER_2_0_0.md](../SEMVER_2_0_0.md).

## Семантическое версионирование (SemVer) 2.0.0

### Формат версий

Версии NormalDANCE следуют формату: `MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD_METADATA]`

- **MAJOR** (основная версия): Изменения, нарушающие обратную совместимость
- **MINOR** (дополнительная версия): Новая функциональность с обратной совместимостью
- **PATCH** (исправление): Исправление ошибок с обратной совместимостью
- **PRERELEASE** (предрелиз): Необязательный предрелизный идентификатор (например, `alpha`, `beta`, `rc.1`)
- **BUILD_METADATA** (метаданные сборки): Необязательная информация о сборке (например, `+202501.abc123`)

### Примеры версий

- `1.0.0` - Первоначальный релиз
- `1.0.1` - Исправление ошибок
- `1.1.0` - Новая функциональность
- `2.0.0` - Изменения, нарушающие обратную совместимость
- `1.0.0-alpha` - Предрелизная версия
- `1.0.0-alpha.1` - Нумерованная предрелизная версия
- `1.0.0-beta.1` - Бета-версия
- `1.0.0-rc.1` - Релиз-кандидат
- `1.0.0+20250101.12345` - Версия с метаданными сборки
- `1.0-alpha.1+exp.sha.5114f85` - Предрелиз с метаданными сборки

## Правила определения версий

### Major версии (MAJOR)

Используются при наличии изменений, нарушающих обратную совместимость API или поведения:

- Удаление API эндпоинтов
- Изменение структуры базы данных с нарушением совместимости
- Удаление конфигурационных опций
- Major обновления зависимостей с нарушением совместимости
- Изменения в архитектуре приложения, влияющие на API
- Изменения в формате данных, хранимых или передаваемых между компонентами

**Примеры коммитов:**

- `feat!: breaking change - remove deprecated API` (используйте `!` для обозначения breaking change)
- `refactor!: major database schema change` (используйте `!` для обозначения breaking change)
- `fix!: critical security issue requiring breaking change` (используйте `!` для обозначения breaking change)

### Minor версии (MINOR)

Используются при добавлении новой функциональности с сохранением обратной совместимости:

- Новый API эндпоинт
- Новая страница или компонент
- Новая функция в существующем модуле
- Улучшения производительности без изменения API
- Новые опции конфигурации (необязательные)
- Добавление новых необязательных параметров в существующие API

**Примеры коммитов:**

- `feat: add new user dashboard`
- `feat: implement track recommendations`
- `feat: add NFT marketplace`

### Patch версии (PATCH)

Используются для исправления ошибок и небольших улучшений без изменения публичного API:

- Исправление багов
- Небольшие улучшения UI
- Оптимизация производительности без изменения API
- Обновления документации
- Небольшие исправления в коде
- Исправления безопасности без изменения API

**Примеры коммитов:**

- `fix: resolve login issue`
- `fix: audio player crash`
- `docs: update API documentation`

## Предрелизные версии

### Типы предрелизных версий

- **Alpha**: `vX.Y.Z-alpha.N` - для внутреннего тестирования
- **Beta**: `vX.Y.Z-beta.N` - для предварительного тестирования
- **Release Candidate**: `vX.Y.Z-rc.N` - для финального тестирования перед релизом

### Порядок предрелизных версий

Следующие версии упорядочены по возрастанию:
`1.0.0-alpha` < `1.0.0-alpha.1` < `1.0.0-beta.0` < `1.0.0-beta.1` < `1.0.0-rc.0` < `1.0.0-rc.1` < `1.0.0`

## Метаданные сборки

Метаданные сборки не влияют на порядок версий, но содержат информацию о конкретной сборке:

- `+build.123` - номер сборки
- `+20250101.githash` - дата и хеш коммита
- `+env.staging` - окружение развертывания

## Процесс управления версиями

### 1. Разработка

Во время разработки разработчики должны использовать следующие префиксы в коммитах в соответствии с Conventional Commits 1.0.0 и SemVer 2.0.0:

- `feat:` - Новая функциональность (увеличивает MINOR версию)
- `feat!:` - Новая функциональность с несовместимыми изменениями (увеличивает MAJOR версию)
- `fix:` - Исправление ошибок (увеличивает PATCH версию)
- `fix!:` - Исправление ошибок с несовместимыми изменениями (увеличивает MAJOR версию)
- `BREAKING CHANGE:` - Сообщение, содержащее "BREAKING CHANGE:" (увеличивает MAJOR версию)
- `docs:` - Документация (увеличивает PATCH версию)
- `style:` - Форматирование кода (увеличивает PATCH версию)
- `refactor:` - Рефакторинг (увеличивает PATCH версию)
- `perf:` - Улучшения производительности (увеличивает PATCH версию)
- `test:` - Тесты (увеличивает PATCH версию)
- `chore:` - Рутинные задачи (увеличивает PATCH версию)

### 2. Автоматическое определение версии

GitHub Actions автоматически определяет тип версии на основе коммитов и метаданных PR для соответствия спецификации SemVer 2.0.0:

1. **Pull Request merge**: Анализирует коммиты в PR для определения типа версии в соответствии с SemVer 2.0.0
2. **Manual trigger**: Позволяет вручную выбрать тип версии или создать предрелизную версию
3. **Release creation**: Создает версию соответствующего типа в соответствии с SemVer 2.0

### 3. Ручное управление версиями

Для ручного управления версиями используйте скрипты, соответствующие спецификации SemVer 2.0.0:

```bash
# Увеличить версию
npm run version:major    # Major версия (например, 1.0.0 -> 2.0.0)
npm run version:minor    # Minor версия (например, 1.0.0 -> 1.1.0)
npm run version:patch    # Patch версия (например, 1.0.0 -> 1.0.1)

# Создание предрелизных версий
npm run version:prerelease --type alpha    # Создать/увеличить предрелизную версию (например, 1.0.0 -> 1.0.0-alpha.0)
npm run version:prerelease --type beta     # Создать/увеличить бета-версию
npm run version:prerelease -- --type rc       # Создать/увеличить релиз-кандидат

# Получить отчет о версиях
npm run version:report

# Показать текущую версию
npm run version:current
```

## Changelog

### Формат

Changelog следует формату [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/) и включает поддержку предрелизных версий в соответствии с SemVer 2.0.0:

```markdown
# Список изменений

## [1.0.0] - 2025-01-15

### Добавлено

- Новая функциональность

### Изменено

- Обновления существующего функционала

### Исправлено

- Исправление ошибок

### Безопасность

- Обновления безопасности

## [1.0.0-rc.1] - 2025-01-10

### Добавлено

- Предварительная функциональность

### Исправлено

- Исправления перед релизом
```

### Автоматическое обновление

Changelog автоматически обновляется при создании новой версии через GitHub Actions с учетом SemVer 2.0.

## CI/CD интеграция

### GitHub Workflow

Основной workflow `.github/workflows/version-management.yml` включает поддержку SemVer 2.0:

1. **Version Validation**: Проверка коммитов для определения типа версии в соответствии с SemVer 2.0
2. **Version Management**: Обновление версий в package.json и changelog с поддержкой предрелизов и метаданных
3. **Release Management**: Создание релизов и артефактов с поддержкой предрелизных тегов
4. **Deployment**: Развертывание в staging/production с учетом типа версии
5. **Notification**: Уведомления о результатах с указанием типа версии

### Среды развертывания

- **Development**: Для разработки с alpha-версиями
- **Staging**: Для тестирования beta и rc версий
- **Production**: Для официальных релизов

### Процесс развертывания

1. Разработка ветке `feature/...` с alpha-версиями при необходимости
2. Merge в `develop` для интеграции (опционально beta-версии)
3. Merge в `main` запускает создание rc-версии для финального тестирования
4. Подтверждение rc-версии запускает создание официального релиза
5. Автоматическое развертывание в production

## Обратная совместимость

### Проверки совместимости

Система автоматически проверяет обратную совместимость при каждом релизе в соответствии с SemVer 2.0:

- **API совместимость**: Проверка эндпоинтов на наличие breaking changes
- **База данных**: Проверка схемы и миграций
- **Конфигурация**: Проверка переменных окружения
- **Зависимости**: Проверка совместимости с новыми версиями
- **Breaking changes**: Проверка и документирование критических изменений

### Ручная проверка

Для ручной проверки совместимости используйте скрипты, соответствующие SemVer 2.0:

```bash
# Проверить совместимость
npm run compatibility:check

# Сгенерировать отчет
npm run compatibility:report

# Валидировать релиз
npm run compatibility:validate

# Создать migration guide
npm run compatibility:guide
```

### Migration Guides

При наличии breaking изменений автоматически создается migration guide с учетом требований SemVer 2.0.0:

- Расположение: `docs/migration-guide-v{version}.md`
- Содержит инструкции по миграции от предыдущей версии
- Включает план отката при необходимости
- Описывает изменения, нарушающие совместимость

## Уведомления о версиях

### Каналы уведомлений

- **Slack**: Канал `#deployments` с указанием типа версии (включая предрелизы)
- **GitHub Releases**: Официальные релизы с тегами SemVer 2.0.0
- **Email**: Уведомления подписчикам о значимых релизах

### Содержание уведомлений

- Номер версии в формате SemVer 2.0.0
- Тип релиза (major/minor/patch/alpha/beta/rc)
- Изменения, включая breaking changes
- Ссылки на документацию и migration guides
- Информация о развертывании

## Теги Git

### Автоматическое создание

Теги автоматически создаются при каждом релизе в соответствии с SemVer 2.0.0:

- Формат: `v{version}` (например, `v1.0.1`, `v2.0.0-alpha.1`, `v1.0.0+20250101.12345`)
- Тип: Аннотированные теги
- Сообщение: Информация о релизе с указанием типа изменений

### Управление тегами

```bash
# Показать существующие теги
npm run version:tags

# Создать тег вручную
git tag -a v1.0.1 -m "Release version 1.0.1"
git push origin v1.0.1
```

## Артефакты релиза

### Типы артефактов

Каждый релиз включает артефакты в соответствии с SemVer 2.0:

- **Source code**: ZIP и TAR.GZ архивы
- **Docker image**: Контейнер для развертывания с метками версий
- **Build artifacts**: Скомпилированные файлы
- **Documentation**: Документация и migration guides
- **Metadata**: Информация о сборке и предрелизных версиях

### Хранение артефактов

- **GitHub Releases**: Основное хранилище с поддержкой предрелизов
- **Docker Hub**: Docker образы с тегами SemVer
- **CDN**: Статические файлы с версионированием

## Откат версий

### Процесс отката

1. **Откат кода**: Возврат к предыдущей версии с учетом SemVer
2. **Откат базы данных**: Откат миграций при необходимости
3. **Откат развертывания**: Откат на уровне инфраструктуры

### Автоматический откат

При критических ошибках в новых версиях (включая предрелизы):

1. Автоматическое уведомление
2. Откат на предыдущую стабильную версию
3. Создание issue для анализа проблемы

### Ручной откат

```bash
# Откат к предыдущей версии
git checkout v1.0
npm install
npm run deploy:production
```

## Мониторинг версий

### Версионное отслеживание

- **GitHub Releases**: История релизов с предрелизами
- **Changelog**: Подробный список изменений
- **Metrics**: Метрики использования версий

### Аналитика версий

- Популярность версий (включая предрелизы)
- Скорость обновления
- Проблемы совместимости
- Производительность по версиям
- Уровень стабильности предрелизных версий

## Best Practices

### Разработка

1. **Используйте осмысленные коммиты**: Четко описывайте изменения с учетом SemVer 2.0.0
2. **Следуйте соглашениям**: Используйте стандартные префиксы и обозначения breaking changes
3. **Проверяйте совместимость**: Тестируйте изменения на совместимость
4. **Документируйте изменения**: Обновляйте документацию, особенно при breaking changes

### Релизы

1. **Тестируйте thoroughly**: Проводите полное тестирование перед релизом, включая предрелизные версии
2. **Создавайте бэкапы**: Всегда делайте бэкап перед крупными релизами
3. **Планируйте откаты**: Имейте план отката на случай проблем
4. **Уведомляйте пользователей**: Сообщайте о важных изменениях, особенно о breaking changes

### Поддержка предрелизных версий

1. **Ясно обозначайте статус**: Указывайте статус предрелизных версий
2. **Собирайте обратную связь**: Активно собираете отзывы по предрелизам
3. **Документируйте ограничения**: Описывайте ограничения предрелизных версий
4. **Планируйте сроки**: Устанавливайте сроки для предрелизных версий

## Инструменты

### Автоматизация

- **GitHub Actions**: CI/CD pipeline с поддержкой SemVer 2.0
- **Version Manager**: Скрипты управления версиями с поддержкой предрелизов и метаданных
- **Compatibility Manager**: Проверки совместимости в соответствии с SemVer 2.0.0

### Ручные инструменты

- **Git**: Контроль версии кода с поддержкой тегов SemVer
- **npm/yarn**: Управление зависимостями с поддержкой спецификации SemVer 2.0.0
- **Docker**: Контейнеризация с версионированием образов
- **Kubernetes**: Оркестрация с поддержкой версионных развертываний

## Контактная информация

По вопросам управления версиями обращайтесь:

- **Email**: versions@normaldance.com
- **Slack**: Канал `#versions`
- **GitHub Issues**: https://github.com/normaldance/normaldance/issues

---

**Версия документа:** 2.0  
**Дата последнего обновления:** 2025-10-09  
**Автор:** NormalDance DevOps Team
